<div class="team-management-dashboard" [class.sidebar-collapsed]="sidebarCollapsed" role="main">
  <!-- Screen reader announcements -->
  <div aria-live="polite" aria-atomic="true" class="sr-only" id="dashboard-announcements">
    {{ screenReaderAnnouncement }}
  </div>

  <!-- Skip link for keyboard navigation -->
  <a href="#main-content" class="skip-link">
    Pular para o conteúdo principal
  </a>

  <!-- Sidebar -->
  <aside class="dashboard-sidebar" [class.collapsed]="sidebarCollapsed" role="complementary" aria-label="Filtros e métricas da equipe">
    <c4u-card class="sidebar-card">
      <div class="sidebar-content">
        <!-- Team Selector -->
        <div class="sidebar-section">
          <label class="selector-label" for="team-selector">Equipe / Departamento</label>
          <c4u-team-selector
            id="team-selector"
            [teams]="teams"
            [selectedTeam]="selectedTeamId"
            (teamSelected)="onTeamChange($event)"
            aria-label="Selecionar equipe ou departamento">
          </c4u-team-selector>
        </div>

        <!-- Collaborator Selector -->
        <div class="sidebar-section">
          <label class="selector-label" for="collaborator-selector">Colaborador</label>
          <c4u-collaborator-selector
            id="collaborator-selector"
            [collaborators]="collaborators"
            [selectedCollaborator]="selectedCollaborator"
            (collaboratorSelected)="onCollaboratorChange($event)"
            aria-label="Filtrar por colaborador">
          </c4u-collaborator-selector>
        </div>

        <!-- Point Wallet -->
        <div class="sidebar-section" *ngIf="!isLoadingSidebar && !hasSidebarError; else sidebarLoadingOrError" role="region" aria-label="Carteira de pontos da equipe">
          <c4u-point-wallet
            *ngIf="teamPointWallet"
            [points]="teamPointWallet"
            [mediaPontos]="selectedCollaborator ? undefined : teamAveragePoints">
          </c4u-point-wallet>
          
          <c4u-shimmer *ngIf="isLoadingSidebar && !teamPointWallet"></c4u-shimmer>
        </div>
        
        <!-- Season Progress -->
        <div class="sidebar-section" *ngIf="!isLoadingSidebar && !hasSidebarError; else sidebarLoadingOrError" role="region" aria-label="Progresso da temporada da equipe">
          <c4u-season-progress
            *ngIf="teamSeasonProgress"
            [progress]="teamSeasonProgress"
            [processosFinalizados]="progressMetrics.processosFinalizados">
          </c4u-season-progress>
          
          <c4u-shimmer *ngIf="isLoadingSidebar && !teamSeasonProgress"></c4u-shimmer>
        </div>
        

        <ng-template #sidebarLoadingOrError>
          <div class="sidebar-section" *ngIf="isLoadingSidebar" role="status" aria-live="polite">
            <c4u-shimmer></c4u-shimmer>
          </div>
          
          <div class="sidebar-section" *ngIf="hasSidebarError && !isLoadingSidebar" role="alert" aria-live="assertive">
            <c4u-error-message
              [message]="sidebarErrorMessage"
              [showRetry]="true"
              [isRetrying]="isLoadingSidebar"
              (retry)="retrySidebarData()">
            </c4u-error-message>
          </div>
        </ng-template>
        
        <!-- Sidebar Toggle Button - At the end of sidebar content -->
        <div class="sidebar-section sidebar-toggle-section">
          <button class="sidebar-toggle" (click)="toggleSidebar()" [attr.aria-label]="sidebarCollapsed ? 'Expandir menu' : 'Recolher menu'">
            <i [class]="sidebarCollapsed ? 'ri-arrow-right-line' : 'ri-arrow-left-line'" class="toggle-icon"></i>
            <span class="toggle-text">{{ sidebarCollapsed ? 'Expandir' : 'Recolher' }}</span>
          </button>
        </div>
      </div>
      
      <!-- Collapsed Sidebar - Compact View -->
      <div class="sidebar-compact" *ngIf="sidebarCollapsed">
        <!-- Point Wallet Compact -->
        <div class="compact-item" *ngIf="teamPointWallet">
          <i class="ri-lock-fill compact-icon bloqueados"></i>
          <span class="compact-value">{{ teamPointWallet.bloqueados | number:'1.0-0':'pt-BR' }}</span>
        </div>
        <div class="compact-item" *ngIf="teamPointWallet">
          <i class="ri-lock-unlock-fill compact-icon desbloqueados"></i>
          <span class="compact-value">{{ teamPointWallet.desbloqueados | number:'1.0-0':'pt-BR' }}</span>
        </div>
        
        <!-- Season Progress Compact -->
        <div class="compact-item" *ngIf="teamSeasonProgress">
          <i class="ri-building-line compact-icon clientes"></i>
          <span class="compact-value">{{ teamSeasonProgress.clientes | number:'1.0-0':'pt-BR' }}</span>
        </div>
        <div class="compact-item" *ngIf="teamSeasonProgress">
          <i class="ri-checkbox-circle-line compact-icon tarefas"></i>
          <span class="compact-value">{{ teamSeasonProgress.tarefasFinalizadas | number:'1.0-0':'pt-BR' }}</span>
        </div>
        
        <!-- Additional Metrics Compact -->
        <div class="compact-item" *ngIf="teamAveragePoints > 0">
          <i class="ri-star-fill compact-icon media"></i>
          <span class="compact-value">{{ teamAveragePoints | number:'1.0-0':'pt-BR' }}</span>
        </div>
        <div class="compact-item" *ngIf="progressMetrics">
          <i class="ri-check-double-line compact-icon processos"></i>
          <span class="compact-value">{{ progressMetrics.processosFinalizados | number:'1.0-0':'pt-BR' }}</span>
        </div>
        
        <!-- Sidebar Toggle Button - Compact View -->
        <div class="compact-item compact-toggle" (click)="toggleSidebar()" role="button" tabindex="0" aria-label="Expandir menu" (keydown.enter)="toggleSidebar()" (keydown.space)="toggleSidebar(); $event.preventDefault()">
          <i class="ri-arrow-right-line compact-icon"></i>
        </div>
      </div>
    </c4u-card>
  </aside>

  <!-- Main Content Area -->
  <main class="dashboard-main" id="main-content" role="main">
    <!-- Header -->
    <div class="dashboard-header" role="banner">
      <c4u-dashboard-navigation></c4u-dashboard-navigation>
      <div class="header-spacer"></div>
      <c4u-seletor-mes 
        [playerId]="getTeamPlayerIdForMonthSelector()" 
        (onSelectedMonth)="onMonthChange($event)">
      </c4u-seletor-mes>
      <button 
        class="refresh-button"
        (click)="refreshData()"
        [disabled]="isLoading"
        [attr.aria-label]="isLoading ? 'Atualizando dados...' : 'Atualizar dados do dashboard'"
        title="Atualizar dados">
        <i class="ri-refresh-line" [class.spinning]="isLoading" aria-hidden="true"></i>
        <span class="refresh-time" *ngIf="lastRefresh">{{ getLastRefreshTime() }}</span>
      </button>
      <button 
        class="logout-button"
        (click)="logout()"
        aria-label="Sair do sistema"
        title="Sair">
        <i class="ri-logout-box-line" aria-hidden="true"></i>
        <span>Sair</span>
      </button>
    </div>
    
    <!-- Tab Navigation - Only show when no specific collaborator is selected -->
    <div class="tab-navigation" *ngIf="!selectedCollaborator" role="tablist" aria-label="Visualizações do dashboard">
        <button 
          class="tab-button"
          role="tab"
          [attr.aria-selected]="activeTab === 'goals'"
          [attr.aria-controls]="'goals-panel'"
          [attr.tabindex]="activeTab === 'goals' ? 0 : -1"
          [class.active]="activeTab === 'goals'"
          (click)="switchTab('goals')"
          (keydown.enter)="switchTab('goals')"
          (keydown.space)="switchTab('goals'); $event.preventDefault()"
          aria-label="Visualizar metas e progresso">
          <i class="fas fa-bullseye" aria-hidden="true"></i>
          <span>Metas e Progresso</span>
        </button>
        <button 
          class="tab-button"
          role="tab"
          [attr.aria-selected]="activeTab === 'productivity'"
          [attr.aria-controls]="'productivity-panel'"
          [attr.tabindex]="activeTab === 'productivity' ? 0 : -1"
          [class.active]="activeTab === 'productivity'"
          (click)="switchTab('productivity')"
          (keydown.enter)="switchTab('productivity')"
          (keydown.space)="switchTab('productivity'); $event.preventDefault()"
          aria-label="Visualizar análise de produtividade">
          <i class="fas fa-chart-line" aria-hidden="true"></i>
          <span>Análise de Produtividade</span>
        </button>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
        <!-- Goals Tab - Show when activeTab is 'goals' OR when a specific collaborator is selected -->
        <div 
          class="tab-pane" 
          *ngIf="activeTab === 'goals' || selectedCollaborator" 
          [@fadeIn]
          role="tabpanel"
          id="goals-panel"
          [attr.aria-labelledby]="'goals-tab'"
          aria-live="polite">
          <div *ngIf="!isLoadingGoals && !hasGoalsError">
            <!-- KPI Section -->
            <section class="dashboard-section" aria-labelledby="kpi-section-title">
              <h3 id="kpi-section-title" class="section-title">Carteira da Equipe</h3>
              
              <div class="kpi-grid" *ngIf="teamKPIs.length > 0" role="group" aria-labelledby="kpi-section-title">
                <c4u-kpi-circular-progress
                  *ngFor="let kpi of teamKPIs; let i = index; trackBy: trackByKpiId"
                  [label]="kpi.label"
                  [current]="roundValue(kpi.current)"
                  [target]="roundValue(kpi.target)"
                  [superTarget]="kpi.superTarget ? roundValue(kpi.superTarget) : undefined"
                  [color]="kpi.color"
                  [unit]="kpi.unit"
                  [colorIndex]="i">
                </c4u-kpi-circular-progress>
              </div>
              
              <div class="kpi-grid" *ngIf="isLoadingKPIs">
                <c4u-shimmer></c4u-shimmer>
                <c4u-shimmer></c4u-shimmer>
              </div>
            </section>
            
            <!-- Progress Section (Activities and Macros) -->
            <section class="dashboard-section" aria-labelledby="progress-section-title">
              <h3 id="progress-section-title" class="section-title">Progresso da Equipe</h3>
              
              <c4u-activity-progress
                *ngIf="teamActivityMetrics && teamProcessMetrics"
                [activities]="teamActivityMetrics"
                [processos]="teamProcessMetrics"
                [monthlyPointsBreakdown]="monthlyPointsBreakdown"
                (cardClicked)="onProgressCardClicked($event)">
              </c4u-activity-progress>
              
              <c4u-shimmer *ngIf="isLoadingGoals"></c4u-shimmer>
            </section>
            
            <!-- Company Portfolio Section -->
            <section class="dashboard-section carteira-section" aria-labelledby="company-section-title">
              <div class="section-header">
                <h3 id="company-section-title" class="section-title">Clientes</h3>
                <!-- <button 
                  type="button" 
                  class="carteira-expand-btn"
                  (click)="openCarteiraModal()"
                  aria-label="Ver todos os clientes">
                  <i class="ri-external-link-line"></i>
                  Ver todos
                </button> -->
              </div>
              
              <c4u-card class="carteira-card">
                <!-- Carteira list from action_log CNPJs -->
                <div *ngIf="teamCarteiraClientes.length > 0" class="carteira-list">
                  <div *ngFor="let cliente of teamCarteiraClientes" 
                       class="carteira-item"
                       (click)="openCompanyDetailModal(cliente)"
                       role="button"
                       tabindex="0"
                       [attr.aria-label]="'Ver detalhes de ' + getCompanyDisplayName(cliente.cnpj)"
                       (keydown.enter)="openCompanyDetailModal(cliente)"
                       (keydown.space)="openCompanyDetailModal(cliente); $event.preventDefault()">
                    <div class="carteira-item-info">
                      <i class="ri-building-line"></i>
                      <span class="carteira-cnpj">{{ getCompanyDisplayName(cliente.cnpj) }}</span>
                    </div>
                    <div class="carteira-item-meta">
                      <!-- KPI Indicator - Compact Display -->
                      <div *ngIf="cliente.deliveryKpi" 
                           class="carteira-kpi-compact" 
                           [ngClass]="'kpi-' + (cliente.deliveryKpi.color || 'default')"
                           [title]="getKpiTooltip(cliente.deliveryKpi)">
                        <span class="kpi-value">{{ formatKpiValue(cliente.deliveryKpi) }}</span>
                        <i class="ri-time-line kpi-icon" aria-hidden="true"></i>
                      </div>
                      <span *ngIf="!cliente.deliveryKpi" class="kpi-na">N/A</span>
                      <span class="carteira-action-count">{{ cliente.actionCount }} tarefas</span>
                      <span class="carteira-process-count">{{ cliente.processCount }} processos</span>
                    </div>
                  </div>
                </div>
                
                <c4u-shimmer *ngIf="isLoadingCarteira"></c4u-shimmer>
                
                <div *ngIf="!isLoadingCarteira && teamCarteiraClientes.length === 0" class="empty-state">
                  <p>Nenhum cliente encontrado na carteira da equipe</p>
                </div>
              </c4u-card>
            </section>
          </div>

          <c4u-shimmer *ngIf="isLoadingGoals"></c4u-shimmer>

          <div *ngIf="hasGoalsError && !isLoadingGoals" role="alert" aria-live="assertive">
            <c4u-error-message
              [message]="goalsErrorMessage"
              [showRetry]="true"
              [isRetrying]="isLoadingGoals"
              (retry)="retryGoalsData()">
            </c4u-error-message>
          </div>
        </div>

        <!-- Productivity Tab - Only show when no specific collaborator is selected -->
        <div 
          class="tab-pane" 
          *ngIf="activeTab === 'productivity' && !selectedCollaborator" 
          [@fadeIn]
          role="tabpanel"
          id="productivity-panel"
          [attr.aria-labelledby]="'productivity-tab'"
          aria-live="polite">
          <div *ngIf="!isLoadingProductivity && !hasProductivityError" class="productivity-charts-container">
            <!-- Shared Controls -->
            <div class="productivity-shared-controls">
              <c4u-time-period-selector
                [periods]="[7, 15, 30, 60, 90]"
                [selectedPeriod]="selectedPeriod"
                (periodSelected)="onPeriodChange($event)"
                aria-label="Selecionar período de análise">
              </c4u-time-period-selector>
            </div>

            <!-- Activities Chart -->
            <section class="dashboard-section" aria-labelledby="activities-chart-title">
              <h3 id="activities-chart-title" class="section-title">Volume de Atividades por Dia</h3>
              <c4u-productivity-analysis-tab
                [graphData]="graphData"
                [chartDatasetsInput]="graphDatasets"
                [selectedPeriod]="selectedPeriod"
                [isLoading]="isLoadingProductivity"
                [externalChartType]="'line'"
                [hideHeader]="true">
              </c4u-productivity-analysis-tab>
            </section>

            <!-- Points Chart -->
            <section class="dashboard-section" aria-labelledby="points-chart-title">
              <h3 id="points-chart-title" class="section-title">Volume de Pontos por Dia</h3>
              <c4u-productivity-analysis-tab
                [graphData]="pointsGraphData"
                [chartDatasetsInput]="pointsGraphDatasets"
                [selectedPeriod]="selectedPeriod"
                [isLoading]="isLoadingProductivity"
                [externalChartType]="'line'"
                [hideHeader]="true">
              </c4u-productivity-analysis-tab>
            </section>

            <!-- Activities by Collaborator Chart -->
            <section class="dashboard-section" aria-labelledby="activities-by-collaborator-chart-title">
              <h3 id="activities-by-collaborator-chart-title" class="section-title">Total de Atividades por Colaborador</h3>
              <div class="chart-container" [class.loading]="isLoadingProductivity">
                <div *ngIf="isLoadingProductivity" class="loading-overlay" role="status" aria-live="polite">
                  <div class="spinner-border text-primary" role="status" aria-hidden="true">
                    <span class="visually-hidden">Carregando dados...</span>
                  </div>
                  <p class="loading-text">Carregando dados do gráfico...</p>
                </div>
                <div *ngIf="!isLoadingProductivity && activitiesByCollaboratorDatasets.length > 0" class="chart-wrapper">
                  <c4u-grafico-barras
                    [labels]="activitiesByCollaboratorLabels"
                    [datasets]="activitiesByCollaboratorDatasets"
                    [showLegend]="false"
                    role="img"
                    [attr.aria-label]="'Gráfico de barras mostrando total de atividades por colaborador'">
                  </c4u-grafico-barras>
                </div>
                <div *ngIf="!isLoadingProductivity && activitiesByCollaboratorDatasets.length === 0" class="empty-state" role="status" aria-live="polite">
                  <p class="empty-text">Nenhum dado disponível</p>
                </div>
              </div>
            </section>

            <!-- Points by Collaborator Chart -->
            <section class="dashboard-section" aria-labelledby="points-by-collaborator-chart-title">
              <h3 id="points-by-collaborator-chart-title" class="section-title">Total de Pontos por Colaborador</h3>
              <div class="chart-container" [class.loading]="isLoadingProductivity">
                <div *ngIf="isLoadingProductivity" class="loading-overlay" role="status" aria-live="polite">
                  <div class="spinner-border text-primary" role="status" aria-hidden="true">
                    <span class="visually-hidden">Carregando dados...</span>
                  </div>
                  <p class="loading-text">Carregando dados do gráfico...</p>
                </div>
                <div *ngIf="!isLoadingProductivity && pointsByCollaboratorDatasets.length > 0" class="chart-wrapper">
                  <c4u-grafico-barras
                    [labels]="pointsByCollaboratorLabels"
                    [datasets]="pointsByCollaboratorDatasets"
                    [showLegend]="false"
                    role="img"
                    [attr.aria-label]="'Gráfico de barras mostrando total de pontos por colaborador'">
                  </c4u-grafico-barras>
                </div>
                <div *ngIf="!isLoadingProductivity && pointsByCollaboratorDatasets.length === 0" class="empty-state" role="status" aria-live="polite">
                  <p class="empty-text">Nenhum dado disponível</p>
                </div>
              </div>
            </section>
          </div>

          <c4u-shimmer *ngIf="isLoadingProductivity"></c4u-shimmer>

          <div *ngIf="hasProductivityError && !isLoadingProductivity" role="alert" aria-live="assertive">
            <c4u-error-message
              [message]="productivityErrorMessage"
              [showRetry]="true"
              [isRetrying]="isLoadingProductivity"
              (retry)="retryProductivityData()">
            </c4u-error-message>
          </div>
        </div>
    </div>
  </main>

  <!-- Progress List Modal -->
  <modal-progress-list
    *ngIf="isProgressModalOpen"
    [playerId]="teamPlayerIdsForModal"
    [listType]="progressModalType"
    [month]="selectedMonth"
    (closed)="onProgressModalClosed()">
  </modal-progress-list>
  
  <!-- Company Carteira Detail Modal -->
  <modal-company-carteira-detail
    *ngIf="isCompanyCarteiraDetailModalOpen && selectedCarteiraCompany"
    [company]="selectedCarteiraCompany"
    [month]="selectedMonth"
    (closed)="onCompanyCarteiraDetailModalClosed()">
  </modal-company-carteira-detail>
  
  <!-- Carteira Modal -->
  <modal-carteira
    *ngIf="isCarteiraModalOpen"
    [playerId]="teamPlayerIdsForModal"
    [month]="selectedMonth"
    (closed)="onCarteiraModalClosed()">
  </modal-carteira>

  <!-- Global Loading Overlay -->
  <div class="loading-overlay" *ngIf="isLoading" role="status" aria-live="polite" aria-atomic="true">
    <div class="loading-content">
      <div class="spinner-border text-light" role="status" aria-hidden="true">
        <span class="sr-only">Carregando...</span>
      </div>
      <p class="loading-text">Carregando dados...</p>
    </div>
  </div>
</div>
