<div class="gamification-dashboard" [class.sidebar-collapsed]="sidebarCollapsed" full role="main" aria-label="Painel de Gamificação">
  <!-- Screen reader announcements -->
  <div aria-live="polite" aria-atomic="true" class="sr-only" id="dashboard-announcements">
    {{ screenReaderAnnouncement }}
  </div>

  <!-- Skip link for keyboard navigation -->
  <a href="#main-content" class="skip-link">
    Pular para o conteúdo principal
  </a>

  <!-- Left Sidebar -->
  <aside class="dashboard-sidebar" [class.collapsed]="sidebarCollapsed" role="complementary" aria-label="Informações do jogador">
    <c4u-card class="sidebar-card">
      <div class="sidebar-content">
        <!-- Season Level -->
        <div class="sidebar-section">
          <c4u-season-level
            *ngIf="playerStatus"
            [level]="playerStatus.seasonLevel"
            [playerName]="playerStatus.name"
            [metadata]="playerStatus.metadata"
            [kpiAveragePercent]="kpiAveragePercent">
          </c4u-season-level>
          
          <c4u-shimmer *ngIf="isLoadingPlayer && !playerStatus"></c4u-shimmer>
        </div>
        
        <!-- Point Wallet -->
        <div class="sidebar-section">
          <c4u-point-wallet
            *ngIf="pointWallet"
            [points]="pointWallet">
          </c4u-point-wallet>
          
          <c4u-shimmer *ngIf="isLoadingPlayer && !pointWallet"></c4u-shimmer>
        </div>
        
        <!-- Season Progress -->
        <div class="sidebar-section">
          <c4u-season-progress
            *ngIf="seasonProgress"
            [progress]="seasonProgress">
          </c4u-season-progress>
          
          <c4u-shimmer *ngIf="isLoadingPlayer && !seasonProgress"></c4u-shimmer>
        </div>
        
        <!-- Sidebar Toggle Button - At the end of sidebar content -->
        <div class="sidebar-section sidebar-toggle-section">
          <button class="sidebar-toggle" (click)="toggleSidebar()" [attr.aria-label]="sidebarCollapsed ? 'Expandir menu' : 'Recolher menu'">
            <i [class]="sidebarCollapsed ? 'ri-arrow-right-line' : 'ri-arrow-left-line'" class="toggle-icon"></i>
            <span class="toggle-text">{{ sidebarCollapsed ? 'Expandir' : 'Recolher' }}</span>
          </button>
        </div>
      </div>
      
      <!-- Collapsed Sidebar - Compact View -->
      <div class="sidebar-compact" *ngIf="sidebarCollapsed">
        <!-- Point Wallet Compact -->
        <div class="compact-item" *ngIf="pointWallet">
          <i class="ri-lock-fill compact-icon bloqueados"></i>
          <span class="compact-value">{{ pointWallet.bloqueados | number:'1.0-0':'pt-BR' }}</span>
        </div>
        <div class="compact-item" *ngIf="pointWallet">
          <i class="ri-lock-unlock-fill compact-icon desbloqueados"></i>
          <span class="compact-value">{{ pointWallet.desbloqueados | number:'1.0-0':'pt-BR' }}</span>
        </div>
        <div class="compact-item" *ngIf="pointWallet">
          <i class="ri-coin-fill compact-icon moedas"></i>
          <span class="compact-value">{{ pointWallet.moedas | number:'1.0-0':'pt-BR' }}</span>
        </div>
        
        <!-- Season Progress Compact -->
        <div class="compact-item" *ngIf="seasonProgress">
          <i class="ri-focus-3-line compact-icon metas"></i>
          <span class="compact-value">{{ seasonProgress.metas.current }}/{{ seasonProgress.metas.target }}</span>
        </div>
        <div class="compact-item" *ngIf="seasonProgress">
          <i class="ri-building-line compact-icon clientes"></i>
          <span class="compact-value">{{ seasonProgress.clientes | number:'1.0-0':'pt-BR' }}</span>
        </div>
        <div class="compact-item" *ngIf="seasonProgress">
          <i class="ri-checkbox-circle-line compact-icon tarefas"></i>
          <span class="compact-value">{{ seasonProgress.tarefasFinalizadas | number:'1.0-0':'pt-BR' }}</span>
        </div>
        
        <!-- Sidebar Toggle Button - Compact View -->
        <div class="compact-item compact-toggle" (click)="toggleSidebar()" role="button" tabindex="0" aria-label="Expandir menu" (keydown.enter)="toggleSidebar()" (keydown.space)="toggleSidebar(); $event.preventDefault()">
          <i class="ri-arrow-right-line compact-icon"></i>
        </div>
      </div>
    </c4u-card>
  </aside>
  
  <!-- Main Content Area -->
  <main class="dashboard-main" id="main-content">
    <!-- Header with Dashboard Navigation and Month Selector -->
    <div class="dashboard-header" role="banner">
      <c4u-dashboard-navigation></c4u-dashboard-navigation>
      <div class="header-spacer"></div>
      <c4u-seletor-mes 
        [playerId]="getPlayerId()" 
        (onSelectedMonth)="onMonthChange($event)">
      </c4u-seletor-mes>
      <button 
        class="refresh-button"
        (click)="refreshData()"
        [disabled]="isLoading"
        [attr.aria-label]="isLoading ? 'Atualizando dados...' : 'Atualizar dados do painel'"
        title="Atualizar dados">
        <i class="ri-refresh-line" [class.spinning]="isLoading" aria-hidden="true"></i>
        <span class="refresh-time" *ngIf="lastRefreshTime">{{ formattedRefreshTime }}</span>
      </button>
      <button 
        class="logout-button"
        (click)="logout()"
        aria-label="Sair do sistema"
        title="Sair">
        <i class="ri-logout-box-line" aria-hidden="true"></i>
        <span>Sair</span>
      </button>
    </div>
    
    <!-- KPI Section -->
    <section class="dashboard-section" aria-labelledby="kpi-section-title">
      <h2 id="kpi-section-title" class="section-title">Minha Carteira</h2>
      
      <div class="kpi-grid" *ngIf="playerKPIs.length > 0" role="group" aria-labelledby="kpi-section-title">
        <c4u-kpi-circular-progress
          *ngFor="let kpi of playerKPIs; let i = index; trackBy: trackByKpiId"
          [label]="kpi.label"
          [current]="roundValue(kpi.current)"
          [target]="roundValue(kpi.target)"
          [superTarget]="kpi.superTarget ? roundValue(kpi.superTarget) : undefined"
          [color]="kpi.color"
          [unit]="kpi.unit"
          [colorIndex]="i">
        </c4u-kpi-circular-progress>
      </div>
      
      <div class="kpi-grid" *ngIf="isLoadingKPIs">
        <c4u-shimmer></c4u-shimmer>
        <c4u-shimmer></c4u-shimmer>
        <c4u-shimmer></c4u-shimmer>
      </div>
    </section>
    
    <!-- Progress Section -->
    <section class="dashboard-section" aria-labelledby="progress-section-title">
      <h2 id="progress-section-title" class="section-title">Meu Progresso</h2>
      
      <c4u-activity-progress
        *ngIf="activityMetrics && processMetrics"
        [activities]="activityMetrics"
        [processos]="processMetrics"
        [monthlyPointsBreakdown]="monthlyPointsBreakdown"
        (cardClicked)="onProgressCardClicked($event)">
      </c4u-activity-progress>
      
      <c4u-shimmer *ngIf="isLoadingProgress"></c4u-shimmer>
    </section>
    
    <!-- Company Portfolio Section -->
    <section class="dashboard-section carteira-section" aria-labelledby="company-section-title">
      <div class="section-header">
        <h2 id="company-section-title" class="section-title">Clientes</h2>
        <!-- <button 
          type="button" 
          class="carteira-expand-btn"
          (click)="openCarteiraModal()"
          aria-label="Ver todos os clientes">
          <i class="ri-external-link-line"></i>
          Ver todos
        </button> -->
      </div>
      
      <c4u-card class="carteira-card">
        <!-- Carteira list from action_log CNPJs -->
        <div *ngIf="carteiraClientes.length > 0" class="carteira-list">
          <div *ngFor="let cliente of carteiraClientes" 
               class="carteira-item"
               (click)="openCompanyDetailModal(cliente)"
               role="button"
               tabindex="0"
               [attr.aria-label]="'Ver detalhes de ' + getCompanyDisplayName(cliente.cnpj)"
               (keydown.enter)="openCompanyDetailModal(cliente)"
               (keydown.space)="openCompanyDetailModal(cliente); $event.preventDefault()">
            <div class="carteira-item-info">
              <i class="ri-building-line"></i>
              <span class="carteira-cnpj">{{ getCompanyDisplayName(cliente.cnpj) }}</span>
            </div>
            <div class="carteira-item-meta">
              <!-- KPI Indicator - Compact Display -->
              <div *ngIf="cliente.deliveryKpi" 
                   class="carteira-kpi-compact" 
                   [ngClass]="'kpi-' + (cliente.deliveryKpi.color || 'default')"
                   [title]="getKpiTooltip(cliente.deliveryKpi)">
                <span class="kpi-value">{{ formatKpiValue(cliente.deliveryKpi.current) }}</span>
                <i class="ri-time-line kpi-icon" aria-hidden="true"></i>
              </div>
              <span *ngIf="!cliente.deliveryKpi" class="kpi-na">N/A</span>
              <span class="carteira-action-count">{{ cliente.actionCount }} tarefas</span>
              <span class="carteira-process-count">{{ cliente.processCount }} processos</span>
            </div>
          </div>
        </div>
        
        <c4u-shimmer *ngIf="isLoadingCarteira"></c4u-shimmer>
        
        <div *ngIf="!isLoadingCarteira && carteiraClientes.length === 0" class="empty-state">
          <p>Nenhum cliente encontrado na carteira</p>
        </div>
      </c4u-card>
    </section>
  </main>
  
  <!-- Company Detail Modal -->
  <modal-company-detail
    *ngIf="selectedCompany"
    [company]="selectedCompany"
    (closed)="onCompanyModalClosed()">
  </modal-company-detail>
  
  <!-- Progress List Modal -->
  <modal-progress-list
    *ngIf="isProgressModalOpen"
    [playerId]="currentPlayerId"
    [listType]="progressModalType"
    [month]="selectedMonth"
    (closed)="onProgressModalClosed()">
  </modal-progress-list>
  
  <!-- Company Carteira Detail Modal -->
  <modal-company-carteira-detail
    *ngIf="isCompanyCarteiraDetailModalOpen && selectedCarteiraCompany"
    [company]="selectedCarteiraCompany"
    [month]="selectedMonth"
    (closed)="onCompanyCarteiraDetailModalClosed()">
  </modal-company-carteira-detail>
  
  <!-- Carteira Modal -->
  <modal-carteira
    *ngIf="isCarteiraModalOpen"
    [playerId]="currentPlayerId"
    [month]="selectedMonth"
    (closed)="onCarteiraModalClosed()">
  </modal-carteira>
</div>
